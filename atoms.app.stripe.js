/* atoms v0.04.15
   http://atoms.tapquo.com
   Copyright (c) 2014 Tapquo S.L. - Licensed MIT */
(function(){"use strict";var __loadScript,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Atoms.Molecule.StripeCreditCard=function(_super){function StripeCreditCard(){return this.post=__bind(this.post,this),this._onStripeCreateToken=__bind(this._onStripeCreateToken,this),StripeCreditCard.__super__.constructor.apply(this,arguments)}return __extends(StripeCreditCard,_super),StripeCreditCard.available=["Atom.Input","Atom.Button"],StripeCreditCard.events=["submit"],StripeCreditCard["extends"]=!0,StripeCreditCard["default"]={events:["submit","error"],children:[{"Atom.Input":{id:"card_number",placeholder:"Type your credit card number",required:!0,events:["change"],callbacks:["validate"]}},{"Atom.Input":{id:"card_cvc",placeholder:"Type your credit card cvc",required:!0,events:["change"],callbacks:["validate"]}},{"Atom.Input":{id:"card_expiry_month",placeholder:"MM",required:!0,events:["change"],callbacks:["validate"]}},{"Atom.Input":{id:"card_expiry_year",placeholder:"YYYY",required:!0,events:["change"],callbacks:["validate"]}},{"Atom.Button":{text:"submit payment",style:"fluid accept"}}]},StripeCreditCard.prototype.output=function(){var exists;return StripeCreditCard.__super__.output.apply(this,arguments),exists=Atoms.$("[data-extension=stripe]").length>0,exists?this.__init():__loadScript(this.__init)},StripeCreditCard.prototype.onButtonTouch=function(event){var parameters,_ref,_ref1,_ref2;return event.preventDefault(),null!=this.attributes.url&&null!=this.attributes.stripeKey&&this.validate()?(null!=(_ref=Atoms.App)&&null!=(_ref1=_ref.Modal)&&null!=(_ref2=_ref1.Loading)&&_ref2.show(),Stripe.setPublishableKey(this.attributes.stripeKey),parameters={number:this.card_number.el.val(),cvc:this.card_cvc.el.val(),exp_month:this.card_expiry_month.el.val(),exp_year:this.card_expiry_year.el.val()},window.Stripe.createToken(parameters,this._onStripeCreateToken)):this.bubble("error","?"),!1},StripeCreditCard.prototype._onStripeCreateToken=function(status,response){var _ref,_ref1,_ref2;return response.error?null!=(_ref=Atoms.App)&&null!=(_ref1=_ref.Modal)&&null!=(_ref2=_ref1.Loading)?_ref2.hide():void 0:this.post(response.id)},StripeCreditCard.prototype.validate=function(){return Stripe.validateCardNumber(this.card_number.el.val())?Stripe.validateCVC(this.card_cvc.el.val())?Stripe.validateExpiry(this.card_expiry_month.el.val(),this.card_expiry_year.el.val())?!0:(console.log("Invalid Expiry Date"),!1):(console.log("Invalid CVC"),!1):(console.log("Invalid Card Number"),!1)},StripeCreditCard.prototype.post=function(token){return $$.ajax({url:this.attributes.url,type:"POST",data:{stripeToken:token},dataType:"json",contentType:"application/x-www-form-urlencoded",success:function(xhr){var _ref,_ref1,_ref2;return null!=(_ref=Atoms.App)&&null!=(_ref1=_ref.Modal)&&null!=(_ref2=_ref1.Loading)&&_ref2.hide(),console.log(xhr)},error:function(){return function(){var _ref,_ref1,_ref2;return null!=(_ref=Atoms.App)&&null!=(_ref1=_ref.Modal)&&null!=(_ref2=_ref1.Loading)?_ref2.hide():void 0}}(this)})},StripeCreditCard}(Atoms.Molecule.Form),__loadScript=function(callback){var script;return window.google={maps:{}},script=document.createElement("script"),script.type="text/javascript",script.src="https://js.stripe.com/v1/",script.setAttribute("data-extension","stripe"),script.onload=function(){return null!=callback?callback.call(this):void 0},document.body.appendChild(script)},Atoms.$(function(){return new Atoms.Molecule.StripeCreditCard({container:"body",url:"http://localhost:8080/stripe",stripeKey:"pk_test_INaJhR0dwOhLo9PAfK4IKH6n"})})}).call(this);